---
title: Nacos服务消费者注册和负载
linktitle: Nacos服务消费者注册和负载
toc: true
type: docs
date: "2020-08-10T00:00:00+01:00"
draft: false
menu:
  cloud-albaba:
    parent: Spring-Cloud-Alibaba-Necos
    weight: 3
---


## 新建项目

`cloudalibaba-consumer-nacos-order8013`


## pom

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

## yml
```
server:
  port: 8013

spring:
  application:
    name: nacos-order-consumer
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848

#消费者将要去访问的微服务名称（注册成功进nacos的微服务提供者）
service-url:
  nacos-user-service: http://nacos-payment-provider
```

## Config

nacos自带了负载均衡，所以需要加上@LoadBalanced注解

```java
package com.cloud.provider.comsumer.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

/**
 *
 * @author yzg
 * @version 1.0
 * @create 2020/08/10
 */
@Configuration
public class ApplicationContextConfig {

    @Bean
    @LoadBalanced
    public RestTemplate getRestTemplate(){
        return new RestTemplate();
    }
}

```

## controller

```java
package com.cloud.provider.comsumer.controller;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import javax.annotation.Resource;

/**
 *
 * @author yzg
 * @version 1.0
 * @create 2020/08/10
 */
@RestController
@Slf4j
public class OrderNacosController {

    @Resource
    private RestTemplate restTemplate;

    @Value("${service-url.nacos-user-service}")
    private String serverUrl;

    @GetMapping("/consumer/payment/nacos/{id}")
    public String paymentInfo(@PathVariable("id") Integer id){
        return restTemplate.getForObject(serverUrl + "/payment/nacos/" + id, String.class);
    }
}

```


## 启动类

```java
package com.cloud.provider.comsumer;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class OrderNacosMain8013 {
    public static void main(String[] args) {
        SpringApplication.run(OrderNacosMain8013.class, args);
    }
}

```
## 测试
运行`cloudAlibaba-provider-payment9001`  
运行`cloudAlibaba-provider-payment9002`  
运行`cloudalibaba-consumer-nacos-order8013`  

