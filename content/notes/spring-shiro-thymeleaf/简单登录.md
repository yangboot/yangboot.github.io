---
title: spring+shiro+MyBatis实现登录认证
draft: false  # Is this a draft? true/false
toc: true  # Show table of contents? true/false
type: docs  # Do not modify.
weight: 1
menu:
  spring-shiro-thymeleaf:
   parent: spring+shiro+thymeleaf用户登录授权
   weight: 2

# Prev/next pager order (if `docs_section_pager` enabled in `params.toml`)
weight: 1
---


## 效果
![](/img/shiro/5.gif)

## 包结构

![](/img/shiro/3.jpg)

## 导入依赖


#### pom.xml

```java
<project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

	<modelVersion>4.0.0</modelVersion>

	<!-- 继承springboot父工程 -->
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>1.5.4.RELEASE</version>
	</parent>

	<groupId>com.yzg</groupId>
	<artifactId>springboot-shiro</artifactId>
	<version>0.0.1-SNAPSHOT</version>

	<dependencies>

		<!-- 导入thymeleaf依赖 -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-thymeleaf</artifactId>
		</dependency>

		<!-- 导入WEB支持 -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<!-- 导入shiro依赖 -->
		<dependency>
			<groupId>org.apache.shiro</groupId>
			<artifactId>shiro-spring</artifactId>
			<version>1.4.0</version>
		</dependency>



		<!-- 导入阿里巴巴连接池 -->
		<dependency>
			<groupId>com.alibaba</groupId>
			<artifactId>druid</artifactId>
			<version>1.0.9</version>
		</dependency>
		<!-- 导入MyBatis启动器 -->
		<dependency>
			<groupId>org.mybatis.spring.boot</groupId>
			<artifactId>mybatis-spring-boot-starter</artifactId>
			<version>1.1.1</version>
		</dependency>
		<!-- 导入mysql连接数据库驱动 -->
		<dependency>
			<groupId>mysql</groupId>
			<artifactId>mysql-connector-java</artifactId>
		</dependency>
	</dependencies>
	<properties>
		<!-- 修改JDK版本 -->
		<java.version>1.8</java.version>
		<!-- 修改thymeleaf版本 -->
		<thymeleaf.version>3.0.2.RELEASE</thymeleaf.version>
		<thymeleaf-layout-dialect.version>2.1.1</thymeleaf-layout-dialect.version>
	</properties>
</project>
```





## 编写application.properties配置文件

```java
server.port=8081

spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/spring_shiro?useUnicode=true&characterEncoding=utf8&characterSetResults=utf8&useSSL=false&serverTimezone=GMT
spring.datasource.username=数据库账号
spring.datasource.password=数据库密码

spring.datasource.type=com.alibaba.druid.pool.DruidDataSource

mybatis.type-aliases-package=com.yzg.domain


```




## 编写shiro配置类


* **创建ShiroFilterFactoryBean**
* **创建DefaultWebSecurityManager**
* **创建Realm**



### ShiroConfig.javajie

shiroFilterFactoryBean.setLoginUrl("/tologin");是只定义登录连接，没有授权登录的都会请求这个这个链接

```java
@Configuration
public class ShiroConfig {
	/**
	 * 创建ShiroFilterFactoryBean
	 */
	@Bean
	public ShiroFilterFactoryBean getShiroFilterFactoryBean(
			@Qualifier("securityManager") DefaultWebSecurityManager securityManager) {
		ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
		Map<String,String>filterMap=new LinkedHashMap<String,String>();
		
		//放行
		filterMap.put("/login", "anon");
		filterMap.put("/testThymeleaf", "anon");
		//拦截
		filterMap.put("/*", "authc");

		//修改用户登录界面路径
		shiroFilterFactoryBean.setLoginUrl("/tologin");
		
		shiroFilterFactoryBean.setFilterChainDefinitionMap(filterMap);
		shiroFilterFactoryBean.setSecurityManager(securityManager);
		return shiroFilterFactoryBean;
	}
	
	/**
	 * 创建DefaultWebSecurityManager
	 */
	@Bean(name = "securityManager")
	public DefaultWebSecurityManager getDefaultWebSecurityManager(@Qualifier("userRealm") UserRealm userRealm) {
		DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();
		securityManager.setRealm(userRealm);
		return securityManager;
	}
	
	/**
	 * 创建Realm
	 */
	@Bean(name = "userRealm")
	public UserRealm getRealm() {
		return new UserRealm();
	}

}
```
## 自定义realm


* **doGetAuthorizationInfo()   执行授权逻辑**

* **doGetAuthenticationInfo()   执行认证逻辑**

### UserRealm。java

SimpleAuthenticationInfo()第一个参数存放的是token相当于session第二个参数存放的是存放的是从数据库查询到的密码，在Realm中只需要输入界面用户输入的token和查询数据库获得的User对象shiro会帮你比对用户名和密码。
```java
public class UserRealm extends AuthorizingRealm{
	@Autowired
	private IUserService userService;
	@Override
	protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {
		System.out.println("执行授权逻辑");
	    return  null;t
	}

	@Override
	protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken agrs) throws AuthenticationException {
		System.out.println("执行认证逻辑");	
		//编写shiro判断逻辑
		//1.判断用户名
		UsernamePasswordToken token=(UsernamePasswordToken)agrs;
		User u=userService.findByUsername(token.getUsername());
		System.out.println("用户"+u+"登录");
		if(u==null||u.equals("")) {
			//用户名不存在
			return null;
		}
		//password是数据库的密码
		return new SimpleAuthenticationInfo(u,u.getPassword(), "");
	}
}
```

## 数据库设计
![](/img/shiro/3.jpg)

## 编写User实体类

```java
public class User {
private Integer id;
private String username;
private String password;
private String name;
private String perms;
public String getPerms() {
	return perms;
}
public void setPerms(String perms) {
	this.perms = perms;
}
public Integer getId() {
	return id;
}
public void setId(Integer id) {
	this.id = id;
}
public String getUsername() {
	return username;
}
public void setUsername(String username) {
	this.username = username;
}
public String getPassword() {
	return password;
}
public void setPassword(String password) {
	this.password = password;
}
public String getName() {
	return name;
}
public void setName(String name) {
	this.name = name;
}

```
## 编写mapper层

### UserMapper.java
```java
public interface UserMapper {
	
	User findByUsername(String username);

}
```
### UserMapper.xml
```java
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yzg.mapper.UserMapper">
<select id="findByUsername" parameterType="string" resultType="user">
SELECT
	id,
	name,
	username,
	password,
	perms
FROM
	user
WHERE
	username = "${value}"
</select>
</mapper>
```
## 编写service层

### IUserService.java
```java
public interface IUserService {
	User findByUsername(String username);
}
```

### UserServiceImpl.java
```java
@Service
public class UserServiceImpl implements IUserService{
	@Autowired
	private UserMapper userMapper;
	
	@Override
	public User findByUsername(String username) {
		return userMapper.findByUsername(username);
	}

}
```

## 编写controller层

shiro是通过捕获异常的方式判断进行登录认证的

### UserController
```java
@Controller
public class UserController {
	/**
	 * 登录逻辑处理
	 * @return
	 */
	@RequestMapping("/login")
	public String login(String username, String password, Model model) {
		Subject subject = SecurityUtils.getSubject();
		UsernamePasswordToken token = new UsernamePasswordToken(username, password);
		try {
			subject.login(token);
			return "redirect:/testThymeleaf";
		} catch (UnknownAccountException e) {
			System.out.println("用户名不存在");
			model.addAttribute("msg","用户名不存在");
			return "login";
		}catch (IncorrectCredentialsException e) {
			System.out.println("密码错误");
			model.addAttribute("msg","密码错误");
			return "login";
		}
	}
	@RequestMapping("/test")
	public String testThymeleaf(Model model) {
		return "test";
	}
	@RequestMapping("/user/add")
	public String add() {
		return "user/add";
	}
	@RequestMapping("/user/update")
	public String update() {
		return "user/update";
	}
	@RequestMapping("/tologin")
	public String tologin() {
		return "login";
	}
}

```

## 编写界面

### 首页

```html
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"></meta>
<title>首页</title>
</head>
<body>
<h3 th:text="${name}"></h3>
<a href="user/add">用户添加</a>
<a href="user/update">用户修改</a>
<a href="tologin">登錄</a>
</body>
</html>
```
### login.html

```html
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"></meta>
<title>用户登录</title>
</head>
<body>
<h3>用户登录</h3>
<form method="post" action="login">
<h3 style="color:red" th:text="${msg}"></h3>
用户名：<input type="text" name="username"><br>
密码：<input type="text" name="password"><br>
<input type="submit" value="登录">
</form>
</body>
</html>
```

### 用户添加
```html
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>用户添加</title>
</head>
<body>
用户添加
</body>
</html>
```
### 用户修改
```html
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>用户修改</title>
</head>
<body>
用户修改
</body>
</html>
```


<script src="/js/copy-to-clipboard.js"></script>
