---
title:  压测卡顿问题
linktitle:  压测卡顿问题
toc: true
type: docs
date: "2020-07-28T00:00:00+01:00"
draft: false
menu:
  cloud-study:
    parent: Hystrix
    weight: 1
---
## 提供端

在提供方`cloud-hystrix-provider-payment8001`写两个方法，一个正常访问一个超时访问

## PaymentService.java  

正常访问

```java
    public String paymentInfo_OK(Integer id) {
        return "线程池:" + Thread.currentThread().getName() + " paymentInfo_OK,id:" + id + "\t" + "O(∩_∩)O哈哈~";
    }

```
超时访问

```java
   public String paymentInfo_TimeOut(Integer id) {
        int timeNumber = 5;
        try {
            // 暂停5秒钟
            TimeUnit.SECONDS.sleep(timeNumber);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return "线程池:" + Thread.currentThread().getName() + " paymentInfo_TimeOut,id:" + id + "\t" +
                "O(∩_∩)O哈哈~  耗时(秒)" + timeNumber;
    }
```

## PaymentController.java

```java
package com.cloud.provider.payment.contrller;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

import com.cloud.provider.payment.service.PaymentService;

import javax.annotation.Resource;

/**
 * @author yzg
 * @create 2020/7/29 9:30
 **/
@RestController
@Slf4j
public class PaymentController {
    @Resource
    private PaymentService paymentService;

    @Value("${server.port}")
    private String servicePort;

    /**
     * 正常访问
     *
     * @param id
     * @return
     */
    @GetMapping("/payment/hystrix/ok/{id}")
    public String paymentInfo_OK(@PathVariable("id") Integer id) {
        String result = paymentService.paymentInfo_OK(id);
        return result;
    }

    /**
     * 超时访问
     *
     * @param id
     * @return
     */
    @GetMapping("/payment/hystrix/timeout/{id}")
    public String paymentInfo_TimeOut(@PathVariable("id") Integer id) {
        String result = paymentService.paymentInfo_TimeOut(id);
        return result;
    }

}

```

​      


## 8001自测

运行cloud-eureka-server7001  
运行cloud-eureka-server7002  
运行cloud-hystrix-provider-payment8001  
访问http://localhost:8001/payment/hystrix/ok/1  （正常请求）  
访问http://localhost:8001/payment/hystrix/timeout/1   （超时请求）  

![](/img/springCloud/2.gif)  

**正常请求访问正常，超时请求访问卡顿**  

 

## 压力测试

![](/img/springCloud/26.jpg)  

![](/img/springCloud/27.jpg)  

![](/img/springCloud/28.jpg)  

![](/img/springCloud/3.gif)  

**这时请求一也卡顿了**     



## 消费端

新建`cloud-openfeign-hystrix-comsumer-order8011`

service

```java
package com.cloud.comsumer.order.service;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.stereotype.Component;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@Component
@FeignClient(value = "CLOUD-PAYMENT-SERVICE")
public interface PaymentFeignService {

	@GetMapping("/payment/hystrix/timeout/{id}")
	public String paymentInfo_TimeOut(@PathVariable("id") Integer id);
    @GetMapping("/payment/hystrix/ok/{id}")
    public String paymentInfo_OK(@PathVariable("id") Integer id);
}

```

controller

```java
package com.cloud.comsumer.order.contrller;

import javax.annotation.Resource;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

import com.cloud.comsumer.order.service.PaymentFeignService;

import lombok.extern.slf4j.Slf4j;

/**
 * @author yzg
 * @create 2020/7/28 11:24
 **/
@RestController
@Slf4j
public class OrderController {
	@Resource
	private PaymentFeignService paymentFeignService;

	/**
	 * 正常访问
	 * 
	 * @param id
	 * @return
	 */
	@GetMapping("/consumer/payment/hystrix/ok/{id}")
	public String paymentInfo_OK(@PathVariable("id") Integer id) {
		return paymentFeignService.paymentInfo_OK(id);

	}

	/**
	 * 超时访问
	 * 
	 * @param id
	 * @return
	 */
	@GetMapping("/consumer/payment/hystrix/timeout/{id}")
	public String paymentInfo_TimeOut(@PathVariable("id") Integer id) {
		return paymentFeignService.paymentInfo_TimeOut(id);
	}
}

```



## 测试

运行cloud-eureka-server7001  
运行cloud-eureka-server7002   
运行cloud-hystrix-provider-payment8001  
运行cloud-openfeign-hystrix-comsumer-order8011  
访问http://localhost:8011/consumer/payment/hystrix/ok/1 (正常请求)
访问http://localhost:8011/consumer/payment/hystrix/timeout/1  （超时请求）
**正常请求访问正常，超时请求访问卡顿**  
经过以上的压力测试  
**正常请求访问卡顿甚至报超时错误，超时请求访问卡顿甚至报超时错误**  


## 总结

Tomcat的默认的工作线程数被打满类，没有多余的线程来分解压力和处理